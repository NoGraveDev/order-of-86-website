<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Generator | Order of 86</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%231C1C1E' width='32' height='32' rx='6'/><text x='16' y='23' font-size='18' font-weight='bold' text-anchor='middle' fill='%23ffd700'>86</text></svg>">
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        body{background:#0a0a0a;color:#F5F5F7;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;min-height:100vh;overflow-x:hidden}

        /* Navigation */
        .nav-bar{display:flex;align-items:center;gap:1.5rem;padding:1rem 2rem;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,215,0,0.1);position:sticky;top:0;z-index:100}
        .nav-bar a{color:#98989D;text-decoration:none;font-size:0.9rem;transition:color 0.2s}
        .nav-bar a:hover,.nav-bar a.active{color:#ffd700}
        .nav-logo-mobile{display:none;color:#ffd700;font-weight:700;font-size:1.1rem}
        .nav-hamburger{display:none;background:none;border:none;color:#ffd700;font-size:1.5rem;cursor:pointer}
        .nav-links-mobile{display:none;flex-direction:column;gap:1rem;padding:2rem;background:rgba(0,0,0,0.98);backdrop-filter:blur(20px);position:fixed;top:0;left:0;right:0;bottom:0;z-index:200}
        .nav-links-mobile.open{display:flex}
        .nav-links-mobile a{color:#F5F5F7;text-decoration:none;font-size:1.3rem;padding:0.5rem 0;border-bottom:1px solid rgba(255,215,0,0.1)}
        .nav-close-mobile{background:none;border:none;color:#ffd700;font-size:2rem;cursor:pointer;align-self:flex-end}
        @media(max-width:768px){.nav-bar a:not(.nav-logo-mobile){display:none}.nav-logo-mobile,.nav-hamburger{display:block}}

        /* Layout */
        .main-container{display:flex;max-width:1400px;margin:0 auto;padding:2rem;gap:2rem;min-height:calc(100vh - 80px)}
        .preview-section{flex:1;min-width:400px}
        .controls-section{flex:1;min-width:450px;max-width:600px}

        @media(max-width:1024px){
            .main-container{flex-direction:column;padding:1rem}
            .preview-section,.controls-section{min-width:auto;max-width:none}
        }

        /* Header */
        .header{text-align:center;margin-bottom:2rem}
        .header h1{font-size:2.5rem;color:#ffd700;margin-bottom:0.5rem;text-shadow:0 2px 8px rgba(255,215,0,0.3)}
        .header h2{font-size:1.1rem;color:#98989D;font-weight:400}

        /* Preview */
        .preview-container{position:sticky;top:120px}
        .preview-frame{position:relative;width:100%;max-width:500px;aspect-ratio:1;margin:0 auto;border-radius:20px;border:3px solid rgba(255,215,0,0.2);background:linear-gradient(45deg,#1a1a1c,#2a2a2e);box-shadow:0 20px 60px rgba(0,0,0,0.8),0 0 30px rgba(255,215,0,0.1);overflow:hidden;transition:border-color 0.3s}
        .preview-frame:hover{border-color:rgba(255,215,0,0.4)}
        .preview-frame .bg-layer{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:opacity 0.3s}
        .preview-frame .dog-layer{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;z-index:1;transition:transform 0.3s}
        .preview-loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:10;transition:opacity 0.3s}
        .preview-loading.hidden{opacity:0;pointer-events:none}
        .spinner{width:40px;height:40px;border:3px solid rgba(255,215,0,0.2);border-top:3px solid #ffd700;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Selection Info */
        .selection-info{text-align:center;margin:1.5rem 0;padding:1rem;background:rgba(255,215,0,0.05);border-radius:12px;border:1px solid rgba(255,215,0,0.1)}
        .wizard-name{font-size:1.3rem;color:#ffd700;font-weight:600;margin-bottom:0.5rem}
        .wizard-count{font-size:0.9rem;color:#98989D}
        .randomize-btn{margin-top:1rem;padding:0.6rem 2rem;background:linear-gradient(135deg,#4a4a4e,#6a6a6e);color:#F5F5F7;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.2s}
        .randomize-btn:hover{transform:translateY(-2px);background:linear-gradient(135deg,#5a5a5e,#7a7a7e);box-shadow:0 8px 25px rgba(0,0,0,0.3)}

        /* Download Buttons */
        .download-section{margin-top:1.5rem}
        .download-buttons{display:flex;gap:0.8rem;flex-wrap:wrap;justify-content:center}
        .download-btn{padding:0.8rem 2rem;background:linear-gradient(135deg,#ffd700,#e6a800);color:#000;font-size:0.95rem;font-weight:700;border:none;border-radius:12px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.03em;min-width:160px}
        .download-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(255,215,0,0.4)}
        .download-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .download-btn.secondary{background:linear-gradient(135deg,#4a4a4e,#6a6a6e);color:#F5F5F7}
        .download-btn.secondary:hover{background:linear-gradient(135deg,#5a5a5e,#7a7a7e)}

        /* Controls Panel */
        .controls-panel{background:linear-gradient(145deg,#1a1a1c,#2a2a2e);border-radius:20px;border:1px solid rgba(255,215,0,0.1);overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.6)}

        /* Tabs */
        .tabs-header{display:flex;border-bottom:1px solid rgba(255,215,0,0.1)}
        .tab-btn{flex:1;padding:1rem;background:none;border:none;color:#98989D;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s;text-transform:uppercase;letter-spacing:0.05em;border-bottom:3px solid transparent}
        .tab-btn:hover{color:#F5F5F7;background:rgba(255,215,0,0.05)}
        .tab-btn.active{color:#ffd700;background:rgba(255,215,0,0.1);border-bottom-color:#ffd700}

        .tab-content{height:500px;overflow-y:auto;padding:1.5rem}
        .tab-content::-webkit-scrollbar{width:6px}
        .tab-content::-webkit-scrollbar-track{background:rgba(255,215,0,0.05)}
        .tab-content::-webkit-scrollbar-thumb{background:rgba(255,215,0,0.2);border-radius:3px}
        .tab-content::-webkit-scrollbar-thumb:hover{background:rgba(255,215,0,0.4)}

        .tab-panel{display:none;animation:fadeIn 0.3s ease-in-out}
        .tab-panel.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

        /* Search & Filters */
        .controls-row{display:flex;gap:0.8rem;margin-bottom:1.5rem;flex-wrap:wrap}
        .search-input{flex:1;min-width:200px;padding:0.8rem 1rem;background:rgba(255,215,0,0.05);border:2px solid rgba(255,215,0,0.1);border-radius:10px;color:#F5F5F7;font-size:0.9rem;outline:none;transition:all 0.2s}
        .search-input:focus{border-color:#ffd700;box-shadow:0 0 15px rgba(255,215,0,0.2)}
        .search-input::placeholder{color:#666}
        .filter-select{padding:0.8rem;background:rgba(255,215,0,0.05);border:2px solid rgba(255,215,0,0.1);border-radius:10px;color:#F5F5F7;cursor:pointer;transition:all 0.2s}
        .filter-select:focus{border-color:#ffd700}

        /* Grids */
        .grid{display:grid;gap:12px;animation:slideUp 0.4s ease-out}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

        .wizards-grid{grid-template-columns:repeat(auto-fill,minmax(70px,1fr))}
        .backgrounds-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}

        /* Wizard Thumbs */
        .wizard-thumb{position:relative;width:100%;aspect-ratio:1;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s;overflow:hidden;background:#2a2a2e;transform-origin:center}
        .wizard-thumb img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s}
        .wizard-thumb:hover{border-color:rgba(255,215,0,0.5);transform:scale(1.08);box-shadow:0 8px 25px rgba(0,0,0,0.4)}
        .wizard-thumb:hover img{transform:scale(1.1)}
        .wizard-thumb.selected{border-color:#ffd700;background:rgba(255,215,0,0.1);box-shadow:0 0 20px rgba(255,215,0,0.6);transform:scale(1.05)}
        .wizard-id{position:absolute;top:4px;left:4px;background:rgba(0,0,0,0.8);color:#ffd700;font-size:0.7rem;font-weight:600;padding:2px 6px;border-radius:4px}

        /* Background Thumbs */
        .bg-thumb{position:relative;width:100%;aspect-ratio:1;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s;overflow:hidden;transform-origin:center}
        .bg-thumb img{width:100%;height:100%;object-fit:cover;transition:transform 0.3s}
        .bg-thumb:hover{border-color:rgba(255,215,0,0.5);transform:scale(1.05);box-shadow:0 8px 25px rgba(0,0,0,0.4)}
        .bg-thumb:hover img{transform:scale(1.1)}
        .bg-thumb.selected{border-color:#ffd700;box-shadow:0 0 20px rgba(255,215,0,0.6);transform:scale(1.02)}
        .bg-thumb.none-bg{display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,#2a2a2e,#3a3a3e);color:#98989D;font-size:0.8rem;font-weight:600}
        .bg-thumb.none-bg:hover{background:linear-gradient(45deg,#3a3a3e,#4a4a4e);color:#F5F5F7}
        .bg-label{position:absolute;bottom:0;left:0;right:0;padding:6px;background:linear-gradient(transparent,rgba(0,0,0,0.9));color:#F5F5F7;font-size:0.7rem;font-weight:600;text-align:center}
        .bg-type-badge{position:absolute;top:6px;right:6px;background:#ffd700;color:#000;font-size:0.6rem;font-weight:700;padding:2px 6px;border-radius:6px;text-transform:uppercase}

        /* Settings */
        .setting-group{margin-bottom:2rem;padding:1.5rem;background:rgba(255,215,0,0.03);border-radius:12px;border:1px solid rgba(255,215,0,0.1)}
        .setting-label{display:block;color:#ffd700;font-size:0.9rem;font-weight:600;margin-bottom:0.8rem;text-transform:uppercase;letter-spacing:0.05em}
        .setting-row{display:flex;gap:1rem;align-items:center;margin-bottom:1rem}
        .setting-input{flex:1;padding:0.6rem;background:rgba(255,215,0,0.05);border:2px solid rgba(255,215,0,0.1);border-radius:8px;color:#F5F5F7;outline:none;transition:border-color 0.2s}
        .setting-input:focus{border-color:#ffd700}
        .setting-value{min-width:60px;color:#98989D;font-size:0.9rem;text-align:right}

        /* Empty States */
        .empty-state{text-align:center;padding:3rem 1rem;color:#666}
        .empty-state h3{color:#98989D;margin-bottom:0.5rem}

        /* Hidden canvas */
        #previewCanvas{display:none}

        /* Mobile responsiveness */
        @media(max-width:768px){
            .main-container{padding:1rem 0.5rem}
            .tabs-header{flex-wrap:wrap}
            .tab-btn{min-width:25%;font-size:0.8rem;padding:0.8rem 0.5rem}
            .controls-row{flex-direction:column}
            .download-buttons{flex-direction:column}
            .setting-row{flex-direction:column;align-items:stretch;gap:0.5rem}
            .setting-value{text-align:left}
        }
    </style>
</head>
<body>
<nav class="nav-bar">
    <span class="nav-logo-mobile">Order of 86</span>
    <a href="index.html">The 86 Wizards</a>
    <a href="moons.html">Moons</a>
    <a href="map.html">Map</a>
    <a href="lore.html">Lore</a>
    <a href="content.html" class="active">Content</a>
    <button class="nav-hamburger" onclick="document.getElementById('navMobileMenu').classList.toggle('open')">&#9776;</button>
</nav>
<div class="nav-links-mobile" id="navMobileMenu">
    <button class="nav-close-mobile" onclick="this.parentElement.classList.remove('open')">&#10005;</button>
    <a href="index.html">The 86 Wizards</a><a href="moons.html">Moons</a><a href="map.html">Map</a><a href="lore.html">Lore</a><a href="content.html">Content</a>
</div>

<div class="header">
    <h1>Content Generator</h1>
    <h2>Mix, match, and create magical content with the 86 Wizards</h2>
</div>

<div class="main-container">
    <!-- Preview Section -->
    <div class="preview-section">
        <div class="preview-container">
            <div class="preview-frame" id="previewFrame">
                <div class="preview-loading" id="previewLoading">
                    <div class="spinner"></div>
                </div>
                <img class="bg-layer" id="bgLayer" src="" style="display:none">
                <img class="dog-layer" id="dogLayer" src="" style="display:none">
            </div>
            
            <div class="selection-info">
                <div class="wizard-name" id="selectedName">Select a wizard to begin</div>
                <div class="wizard-count" id="wizardCount">86 Wizards available</div>
                <button class="randomize-btn" onclick="randomizeSelection()">ðŸŽ² Surprise Me!</button>
            </div>

            <div class="download-section">
                <div class="download-buttons">
                    <button class="download-btn" id="downloadStill" onclick="downloadStill()" disabled>Download Still (PNG)</button>
                    <button class="download-btn secondary" id="downloadBg" onclick="downloadBackground()" disabled style="display:none">Download GIF (with Wizard)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
        <div class="controls-panel">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('wizards')">Wizards</button>
                <button class="tab-btn" onclick="switchTab('animated')">Animated BGs</button>
                <button class="tab-btn" onclick="switchTab('still')">Still BGs</button>
                <button class="tab-btn" onclick="switchTab('settings')">Settings</button>
            </div>

            <!-- Wizards Tab -->
            <div class="tab-content">
                <div class="tab-panel active" id="wizardsTab">
                    <div class="controls-row">
                        <input type="text" class="search-input" id="wizardSearch" placeholder="Search wizards by name or ID...">
                        <select class="filter-select" id="orderFilter" onchange="filterWizards()">
                            <option value="">All Orders</option>
                            <option value="Flame">Flame</option><option value="Wild">Wild</option><option value="Arcane">Arcane</option>
                            <option value="Deep">Deep</option><option value="Radiant">Radiant</option><option value="Heart">Heart</option><option value="Wanderer">Wanderer</option>
                        </select>
                    </div>
                    <div class="grid wizards-grid" id="wizardsGrid"></div>
                </div>

                <!-- Animated Backgrounds Tab -->
                <div class="tab-panel" id="animatedTab">
                    <div class="grid backgrounds-grid" id="animatedBgGrid"></div>
                </div>

                <!-- Still Backgrounds Tab -->
                <div class="tab-panel" id="stillTab">
                    <div class="grid backgrounds-grid" id="stillBgGrid"></div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-panel" id="settingsTab">
                    <div class="setting-group">
                        <label class="setting-label">Wizard Scale</label>
                        <div class="setting-row">
                            <input type="range" class="setting-input" id="dogScale" min="0.5" max="1.5" step="0.1" value="1" oninput="updatePreview()">
                            <span class="setting-value" id="dogScaleValue">100%</span>
                        </div>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Wizard Position</label>
                        <div class="setting-row">
                            <input type="range" class="setting-input" id="dogOffsetX" min="-50" max="50" step="5" value="0" oninput="updatePreview()">
                            <span class="setting-value" id="dogOffsetXValue">0px</span>
                        </div>
                        <div class="setting-row">
                            <input type="range" class="setting-input" id="dogOffsetY" min="-50" max="50" step="5" value="0" oninput="updatePreview()">
                            <span class="setting-value" id="dogOffsetYValue">0px</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<canvas id="previewCanvas" width="1000" height="1000"></canvas>

<script>
const WIZARDS = [
  {id:'165',name:'Vanguard the Glacier Walker',order:'Flame'},{id:'246',name:'Goldburn the Solar Flame',order:'Flame'},
  {id:'986',name:'Splitforge the Dual Natured',order:'Flame'},{id:'1053',name:'Deathforge the Undying',order:'Flame'},
  {id:'1271',name:'Snowcollie the Patient Amplifier',order:'Heart'},{id:'1714',name:'Roseheart the Gentle Flame',order:'Flame'},
  {id:'1841',name:'Ember Beard the Bridge Prophet',order:'Deep'},{id:'1848',name:'Lensfire the Tiger Scholar',order:'Flame'},
  {id:'1976',name:'Frostbark the Ice Grower',order:'Wild'},{id:'1977',name:'Blackclassic the Network Walker',order:'Wild'},
  {id:'2426',name:'Blotbark the Corruption Fighter',order:'Wild'},{id:'2634',name:'Mixedsight the Paradox Prophet',order:'Deep'},
  {id:'2807',name:'Voidbloom the Visor Wearer',order:'Wild'},{id:'2855',name:'Lensheart the Scholarly Amplifier',order:'Heart'},
  {id:'3030',name:'Pureflame the Unadorned',order:'Flame'},{id:'3186',name:'Brownheart the Common Light',order:'Radiant'},
  {id:'3406',name:'Pinkmantle the Dimensional Scholar',order:'Arcane'},{id:'3417',name:'Orangeshield the Flame Prophet',order:'Deep'},
  {id:'3449',name:'Stripeheart the Bridge Walker',order:'Wild'},{id:'3479',name:'Dawnheart the Neutral Amplifier',order:'Heart'},
  {id:'3557',name:'Goldstare the Solar Prophet',order:'Deep'},{id:'3735',name:'Roseheart the Steady Bond',order:'Heart'},
  {id:'3758',name:'Deathbloom the Renewal Bringer',order:'Wild'},{id:'3826',name:'Rosefield the Wild Ember',order:'Wild'},
  {id:'4042',name:'Roseflame the Pink Eyed',order:'Flame'},{id:'4165',name:'Pearlgaze the Emotional Seer',order:'Deep'},
  {id:'4458',name:'Clearsight the Precision Revealer',order:'Radiant'},{id:'4540',name:'Blotforge the Chaos Shaper',order:'Flame'},
  {id:'4650',name:'Sandstone the Stable Amplifier',order:'Arcane'},{id:'4742',name:'Blottedmist the Chaos Seer',order:'Deep'},
  {id:'4994',name:'Whitecoat the Collie Coordinator',order:'Arcane'},{id:'5035',name:'Blizzardflame the Ice Hearted',order:'Flame'},
  {id:'5056',name:'Brownvisor the Research Director',order:'Arcane'},{id:'5177',name:'Frostgrow the Gray Endurer',order:'Wild'},
  {id:'5240',name:'Graysleep the Dream Walker',order:'Arcane'},{id:'5275',name:'Tideforge the Current Rider',order:'Flame'},
  {id:'5374',name:'Redsight the Spotted Tracker',order:'Wild'},{id:'5381',name:'Roseclassic the Pink Diplomat',order:'Radiant'},
  {id:'5516',name:'Whiteguard the Shield Prophet',order:'Deep'},{id:'5518',name:'Voidstrike the Green Eyed',order:'Flame'},
  {id:'5538',name:'Graystorm the Weather Walker',order:'Wild'},{id:'6095',name:'Dalmatianscript the Unique Scholar',order:'Arcane'},
  {id:'6135',name:'Bluevisor the Technology Prophet',order:'Deep'},{id:'6164',name:'The Wanderer',order:'Wanderer'},
  {id:'6198',name:'Ashstripe the Veil Ripper',order:'Arcane'},{id:'6203',name:'Sleepytan the Dream Revealer',order:'Radiant'},
  {id:'6232',name:'Goldsolid the Pure Prophet',order:'Deep'},{id:'6398',name:'Tideseed the Shore Walker',order:'Wild'},
  {id:'6502',name:'Sleepyheart the Dream Bonder',order:'Arcane'},{id:'6597',name:'Inkwell the Archive Prophet',order:'Deep'},
  {id:'6873',name:'Goldleaf the Multi Eyed',order:'Wild'},{id:'7226',name:'Tanwatcher the Patient Prophet',order:'Deep'},
  {id:'7257',name:'Graydreamer the Sleep Prophet',order:'Deep'},{id:'7439',name:'Goldsentry the Gentle Endurer',order:'Arcane'},
  {id:'7710',name:'Goldstrike the Lightning Fast',order:'Flame'},{id:'7731',name:'Beigelight the Steady Illuminator',order:'Radiant'},
  {id:'7770',name:'Stripesight the Pattern Burner',order:'Flame'},{id:'7833',name:'Bronzebeacon the Shiny Light',order:'Radiant'},
  {id:'8095',name:'Rosestrike the Pink Eyed',order:'Flame'},{id:'8154',name:'Grayveil the Foundation Scholar',order:'Arcane'},
  {id:'8272',name:'Spotforge the Pattern Reader',order:'Wild'},{id:'8284',name:'Stripesight the Pattern Hunter',order:'Wild'},
  {id:'8311',name:'Goldvisor the Tiger Theorist',order:'Heart'},{id:'8342',name:'Whiteheart the Split Researcher',order:'Heart'},
  {id:'8518',name:'Goldstripe the Time Stalker',order:'Heart'},{id:'8667',name:'Goldforge the Sun Touched',order:'Flame'},
  {id:'8728',name:'Frostforge the Scarf Bearer',order:'Flame'},{id:'8822',name:'Chaosbloom the Change Bringer',order:'Wild'},
  {id:'8965',name:'Brownthorn the Shield Grower',order:'Wild'},{id:'9017',name:'Sleepysteady the Gentle Dreamer',order:'Heart'},
  {id:'9025',name:'Grayheart the Split Revealer',order:'Radiant'},{id:'9089',name:'Raredheart the Ultimate Amplifier',order:'Heart'},
  {id:'9183',name:'Whiteheart the Pink Eyed Illuminator',order:'Radiant'},{id:'9234',name:'Shadowspot the Pattern Keeper',order:'Arcane'},
  {id:'9301',name:'Rosegold the Pink Eyed Theorist',order:'Heart'},{id:'9396',name:'Tancollar the Diplomatic Light',order:'Radiant'},
  {id:'9469',name:'Whitemist the Sleepy Purifier',order:'Radiant'},{id:'9530',name:'Bernardguard the Truth Keeper',order:'Deep'},
  {id:'9604',name:"Beigelumber the Worker's Light",order:'Radiant'},{id:'9624',name:'Inkspot the Silent Decoder',order:'Arcane'},
  {id:'9684',name:'Goldblot the Luminous Shadow',order:'Radiant'},{id:'9713',name:'Darkleaf the Shadow Grower',order:'Wild'},
  {id:'9758',name:'Commonflame the Everyman',order:'Flame'},{id:'9826',name:'Greenbone the Chaos Scholar',order:'Heart'},
  {id:'9898',name:'Verdant the Arcane Flame',order:'Arcane'},{id:'9952',name:'Grimbloom the Green Eyed',order:'Wild'}
];

const ANIMATED_BACKGROUNDS = [
  {file:'forge-spire.gif',name:'Forge Spire'},{file:'violet-citadel.gif',name:'Violet Citadel'},
  {file:'tidewatch.gif',name:'Tidewatch'},{file:'everhollow.gif',name:'Everhollow'},
  {file:'solar-spire.gif',name:'Solar Spire'},{file:'heartstring-tower.gif',name:'Heartstring Tower'},
  {file:'palehowl-night.gif',name:'Palehowl Night'},{file:'caninosphere.gif',name:'The Caninosphere'},
  {file:'abyssal-library.gif',name:'Abyssal Library'},{file:'shadowmire.gif',name:'Shadowmire Swamp'}
];

// Generate still backgrounds as data URIs
function generateStillBackgrounds() {
    const backgrounds = [];
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800;
    canvas.height = 800;

    // Crystal Cave
    ctx.clearRect(0, 0, 800, 800);
    const gradient1 = ctx.createRadialGradient(400, 400, 0, 400, 400, 400);
    gradient1.addColorStop(0, '#1a0d3e');
    gradient1.addColorStop(1, '#0a0520');
    ctx.fillStyle = gradient1;
    ctx.fillRect(0, 0, 800, 800);
    // Crystals on sides
    ctx.fillStyle = '#4a2c8a';
    ctx.beginPath();
    ctx.moveTo(0, 200); ctx.lineTo(150, 100); ctx.lineTo(180, 300); ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(620, 150); ctx.lineTo(800, 80); ctx.lineTo(800, 250); ctx.closePath();
    ctx.fill();
    ctx.fillStyle = '#7a5cdb';
    ctx.fillRect(50, 400, 120, 200);
    ctx.fillRect(630, 350, 120, 250);
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Crystal Cave'});

    // Moonlit Meadow
    ctx.clearRect(0, 0, 800, 800);
    const gradient2 = ctx.createLinearGradient(0, 0, 0, 800);
    gradient2.addColorStop(0, '#1a1a3a');
    gradient2.addColorStop(1, '#0d1a0d');
    ctx.fillStyle = gradient2;
    ctx.fillRect(0, 0, 800, 800);
    // Trees on edges
    ctx.fillStyle = '#2a4a2a';
    ctx.fillRect(0, 200, 100, 600);
    ctx.fillRect(700, 150, 100, 650);
    ctx.fillStyle = '#1a3a1a';
    ctx.beginPath();
    ctx.arc(50, 200, 60, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(750, 150, 70, 0, Math.PI * 2);
    ctx.fill();
    // Moon
    ctx.fillStyle = '#f0f0aa';
    ctx.beginPath();
    ctx.arc(400, 150, 50, 0, Math.PI * 2);
    ctx.fill();
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Moonlit Meadow'});

    // Enchanted Forest
    ctx.clearRect(0, 0, 800, 800);
    ctx.fillStyle = '#0a2a0a';
    ctx.fillRect(0, 0, 800, 800);
    // Thick trees framing sides
    ctx.fillStyle = '#1a4a1a';
    ctx.fillRect(0, 0, 200, 800);
    ctx.fillRect(600, 0, 200, 800);
    ctx.fillStyle = '#2a6a2a';
    for(let i = 0; i < 5; i++) {
        ctx.fillRect(20 + i * 30, 100 + i * 50, 20, 600);
        ctx.fillRect(620 + i * 30, 80 + i * 60, 20, 650);
    }
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Enchanted Forest'});

    // Wizard Library
    ctx.clearRect(0, 0, 800, 800);
    const gradient3 = ctx.createRadialGradient(400, 400, 0, 400, 400, 400);
    gradient3.addColorStop(0, '#3a2a1a');
    gradient3.addColorStop(1, '#1a0a0a');
    ctx.fillStyle = gradient3;
    ctx.fillRect(0, 0, 800, 800);
    // Bookshelves on sides
    ctx.fillStyle = '#4a3a2a';
    ctx.fillRect(0, 100, 150, 600);
    ctx.fillRect(650, 100, 150, 600);
    ctx.fillStyle = '#8a6a4a';
    for(let i = 0; i < 15; i++) {
        ctx.fillRect(10, 120 + i * 35, 130, 25);
        ctx.fillRect(660, 120 + i * 35, 130, 25);
    }
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Wizard Library'});

    // Sunset Cliffs
    ctx.clearRect(0, 0, 800, 800);
    const gradient4 = ctx.createLinearGradient(0, 0, 0, 800);
    gradient4.addColorStop(0, '#ff6a3a');
    gradient4.addColorStop(0.5, '#ff9a6a');
    gradient4.addColorStop(1, '#aa3a1a');
    ctx.fillStyle = gradient4;
    ctx.fillRect(0, 0, 800, 800);
    // Rock formations on sides
    ctx.fillStyle = '#4a2a1a';
    ctx.beginPath();
    ctx.moveTo(0, 800); ctx.lineTo(0, 300); ctx.lineTo(180, 500); ctx.lineTo(200, 800); ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(800, 800); ctx.lineTo(800, 250); ctx.lineTo(620, 450); ctx.lineTo(600, 800); ctx.closePath();
    ctx.fill();
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Sunset Cliffs'});

    // Starfield Void
    ctx.clearRect(0, 0, 800, 800);
    ctx.fillStyle = '#000510';
    ctx.fillRect(0, 0, 800, 800);
    // Nebula at edges
    const gradient5 = ctx.createRadialGradient(100, 400, 0, 100, 400, 200);
    gradient5.addColorStop(0, 'rgba(138, 43, 226, 0.3)');
    gradient5.addColorStop(1, 'rgba(138, 43, 226, 0)');
    ctx.fillStyle = gradient5;
    ctx.fillRect(0, 200, 300, 400);
    const gradient6 = ctx.createRadialGradient(700, 400, 0, 700, 400, 200);
    gradient6.addColorStop(0, 'rgba(255, 20, 147, 0.3)');
    gradient6.addColorStop(1, 'rgba(255, 20, 147, 0)');
    ctx.fillStyle = gradient6;
    ctx.fillRect(500, 200, 300, 400);
    // Stars
    ctx.fillStyle = '#ffffff';
    for(let i = 0; i < 50; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * 800, Math.random() * 800, Math.random() * 2, 0, Math.PI * 2);
        ctx.fill();
    }
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Starfield Void'});

    // Ancient Ruins
    ctx.clearRect(0, 0, 800, 800);
    ctx.fillStyle = '#2a2a1a';
    ctx.fillRect(0, 0, 800, 800);
    // Pillars on sides
    ctx.fillStyle = '#6a6a5a';
    ctx.fillRect(50, 100, 80, 600);
    ctx.fillRect(670, 100, 80, 600);
    ctx.fillRect(30, 80, 120, 40);
    ctx.fillRect(650, 80, 120, 40);
    // Weathering
    ctx.fillStyle = '#4a4a3a';
    ctx.fillRect(55, 200, 70, 20);
    ctx.fillRect(675, 300, 70, 20);
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Ancient Ruins'});

    // Ember Wasteland
    ctx.clearRect(0, 0, 800, 800);
    const gradient7 = ctx.createLinearGradient(0, 800, 0, 0);
    gradient7.addColorStop(0, '#aa1a0a');
    gradient7.addColorStop(1, '#2a0a0a');
    ctx.fillStyle = gradient7;
    ctx.fillRect(0, 0, 800, 800);
    // Lava flows at edges
    ctx.fillStyle = '#ff4a1a';
    ctx.beginPath();
    ctx.moveTo(0, 600); ctx.lineTo(150, 500); ctx.lineTo(120, 800); ctx.lineTo(0, 800); ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(800, 550); ctx.lineTo(650, 450); ctx.lineTo(680, 800); ctx.lineTo(800, 800); ctx.closePath();
    ctx.fill();
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Ember Wasteland'});

    // Frozen Tundra
    ctx.clearRect(0, 0, 800, 800);
    const gradient8 = ctx.createLinearGradient(0, 0, 0, 800);
    gradient8.addColorStop(0, '#e0f0ff');
    gradient8.addColorStop(1, '#a0c0ff');
    ctx.fillStyle = gradient8;
    ctx.fillRect(0, 0, 800, 800);
    // Ice crystals framing
    ctx.fillStyle = '#c0e0ff';
    ctx.beginPath();
    ctx.moveTo(0, 300); ctx.lineTo(100, 200); ctx.lineTo(150, 350); ctx.lineTo(80, 400); ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(800, 250); ctx.lineTo(700, 150); ctx.lineTo(650, 300); ctx.lineTo(720, 350); ctx.closePath();
    ctx.fill();
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Frozen Tundra'});

    // Mushroom Grove
    ctx.clearRect(0, 0, 800, 800);
    ctx.fillStyle = '#1a3a1a';
    ctx.fillRect(0, 0, 800, 800);
    // Giant mushrooms on sides
    ctx.fillStyle = '#4a2a6a';
    ctx.fillRect(40, 400, 60, 200);
    ctx.fillRect(700, 350, 60, 250);
    ctx.fillStyle = '#8a5a9a';
    ctx.beginPath();
    ctx.arc(70, 400, 80, 0, Math.PI);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(730, 350, 90, 0, Math.PI);
    ctx.fill();
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Mushroom Grove'});

    // Arcane Circle
    ctx.clearRect(0, 0, 800, 800);
    ctx.fillStyle = '#1a0a2a';
    ctx.fillRect(0, 0, 800, 800);
    // Magic circles/runes framing
    ctx.strokeStyle = '#aa6aff';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(150, 400, 100, 0, Math.PI * 2);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(650, 400, 120, 0, Math.PI * 2);
    ctx.stroke();
    // Runes
    ctx.fillStyle = '#aa6aff';
    ctx.font = '30px serif';
    ctx.fillText('âš›', 130, 350);
    ctx.fillText('âš¡', 170, 450);
    ctx.fillText('âœ¦', 630, 350);
    ctx.fillText('â—Š', 670, 450);
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Arcane Circle'});

    // Misty Mountains
    ctx.clearRect(0, 0, 800, 800);
    const gradient9 = ctx.createLinearGradient(0, 800, 0, 0);
    gradient9.addColorStop(0, '#3a3a5a');
    gradient9.addColorStop(1, '#1a1a3a');
    ctx.fillStyle = gradient9;
    ctx.fillRect(0, 0, 800, 800);
    // Peaks on sides
    ctx.fillStyle = '#2a2a4a';
    ctx.beginPath();
    ctx.moveTo(0, 800); ctx.lineTo(0, 300); ctx.lineTo(200, 500); ctx.lineTo(250, 800); ctx.closePath();
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(800, 800); ctx.lineTo(800, 250); ctx.lineTo(600, 450); ctx.lineTo(550, 800); ctx.closePath();
    ctx.fill();
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Misty Mountains'});

    // Underwater Temple
    ctx.clearRect(0, 0, 800, 800);
    const gradient10 = ctx.createRadialGradient(400, 400, 0, 400, 400, 400);
    gradient10.addColorStop(0, '#1a3a5a');
    gradient10.addColorStop(1, '#0a1a3a');
    ctx.fillStyle = gradient10;
    ctx.fillRect(0, 0, 800, 800);
    // Coral/bubbles on sides
    ctx.fillStyle = '#ff6a8a';
    ctx.beginPath();
    ctx.arc(80, 600, 40, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(120, 550, 30, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#6aaa8a';
    ctx.beginPath();
    ctx.arc(720, 580, 45, 0, Math.PI * 2);
    ctx.fill();
    // Bubbles
    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    for(let i = 0; i < 20; i++) {
        ctx.beginPath();
        ctx.arc(Math.random() * 200, 200 + Math.random() * 400, Math.random() * 8 + 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(600 + Math.random() * 200, 200 + Math.random() * 400, Math.random() * 8 + 2, 0, Math.PI * 2);
        ctx.fill();
    }
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Underwater Temple'});

    // Golden Throne Room
    ctx.clearRect(0, 0, 800, 800);
    const gradient11 = ctx.createLinearGradient(0, 0, 0, 800);
    gradient11.addColorStop(0, '#5a4a2a');
    gradient11.addColorStop(1, '#3a2a1a');
    ctx.fillStyle = gradient11;
    ctx.fillRect(0, 0, 800, 800);
    // Ornate pillars
    ctx.fillStyle = '#aa8a4a';
    ctx.fillRect(60, 100, 80, 600);
    ctx.fillRect(660, 100, 80, 600);
    ctx.fillRect(40, 80, 120, 40);
    ctx.fillRect(640, 80, 120, 40);
    // Red carpet center
    ctx.fillStyle = '#8a2a2a';
    ctx.fillRect(300, 600, 200, 200);
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Golden Throne Room'});

    // Cherry Blossom Garden
    ctx.clearRect(0, 0, 800, 800);
    const gradient12 = ctx.createLinearGradient(0, 0, 0, 800);
    gradient12.addColorStop(0, '#ffa8d8');
    gradient12.addColorStop(1, '#d88ab8');
    ctx.fillStyle = gradient12;
    ctx.fillRect(0, 0, 800, 800);
    // Branches framing sides
    ctx.strokeStyle = '#8a4a2a';
    ctx.lineWidth = 8;
    ctx.beginPath();
    ctx.moveTo(0, 200); ctx.quadraticCurveTo(100, 150, 200, 300);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(800, 180); ctx.quadraticCurveTo(700, 130, 600, 280);
    ctx.stroke();
    // Blossoms
    ctx.fillStyle = '#ffaae8';
    for(let i = 0; i < 30; i++) {
        if(i < 15) {
            ctx.beginPath();
            ctx.arc(Math.random() * 200, 100 + Math.random() * 200, Math.random() * 8 + 3, 0, Math.PI * 2);
            ctx.fill();
        } else {
            ctx.beginPath();
            ctx.arc(600 + Math.random() * 200, 100 + Math.random() * 200, Math.random() * 8 + 3, 0, Math.PI * 2);
            ctx.fill();
        }
    }
    backgrounds.push({dataUri: canvas.toDataURL(), name: 'Cherry Blossom Garden'});

    return backgrounds;
}

const STILL_BACKGROUNDS = generateStillBackgrounds();

// State
let selectedWizard = null;
let selectedBackground = null;
let filteredWizards = WIZARDS;
let currentTab = 'wizards';

// DOM Elements
const canvas = document.getElementById('previewCanvas');
const ctx = canvas.getContext('2d');
const bgLayer = document.getElementById('bgLayer');
const dogLayer = document.getElementById('dogLayer');
const previewLoading = document.getElementById('previewLoading');

// Tab Management
function switchTab(tab) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
    
    // Update tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.getElementById(tab + 'Tab').classList.add('active');
    
    currentTab = tab;
}

// Wizard Management
function buildWizardGrid(query = '', order = '') {
    const queryLower = query.toLowerCase();
    filteredWizards = WIZARDS.filter(w => 
        (!order || w.order === order) && 
        (!queryLower || w.name.toLowerCase().includes(queryLower) || w.id.includes(queryLower))
    );
    
    document.getElementById('wizardCount').textContent = 
        `${filteredWizards.length} of 86 Wizards ${query || order ? '(filtered)' : ''}`;
    
    const grid = document.getElementById('wizardsGrid');
    grid.innerHTML = filteredWizards.map(w => `
        <div class="wizard-thumb ${selectedWizard && selectedWizard.id === w.id ? 'selected' : ''}" 
             onclick="selectWizard('${w.id}')" title="#${w.id} ${w.name}">
            <div class="wizard-id">#${w.id}</div>
            <img src="wizard-images/${w.id}.png" alt="${w.name}" loading="lazy">
        </div>
    `).join('');
}

function selectWizard(id) {
    selectedWizard = WIZARDS.find(w => w.id === id);
    showLoading();
    
    dogLayer.onload = () => {
        updatePreview();
        hideLoading();
        updateDownloadButtons();
    };
    dogLayer.src = `wizard-images-transparent/${id}.png`;
    dogLayer.style.display = 'block';
    
    document.getElementById('selectedName').textContent = `#${id} ${selectedWizard.name}`;
    buildWizardGrid(document.getElementById('wizardSearch').value, document.getElementById('orderFilter').value);
}

// Background Management
function buildAnimatedBgGrid() {
    const grid = document.getElementById('animatedBgGrid');
    let html = `<div class="bg-thumb none-bg ${!selectedBackground ? 'selected' : ''}" onclick="clearBackground()">None</div>`;
    html += ANIMATED_BACKGROUNDS.map(bg => `
        <div class="bg-thumb ${selectedBackground && selectedBackground.file === bg.file ? 'selected' : ''}" 
             onclick="selectAnimatedBackground('${bg.file}')">
            <div class="bg-type-badge">GIF</div>
            <img src="content-bg/${bg.file}" alt="${bg.name}" loading="lazy">
            <div class="bg-label">${bg.name}</div>
        </div>
    `).join('');
    grid.innerHTML = html;
}

function buildStillBgGrid() {
    const grid = document.getElementById('stillBgGrid');
    let html = `<div class="bg-thumb none-bg ${!selectedBackground ? 'selected' : ''}" onclick="clearBackground()">None</div>`;
    html += STILL_BACKGROUNDS.map((bg, index) => `
        <div class="bg-thumb ${selectedBackground && selectedBackground.dataUri === bg.dataUri ? 'selected' : ''}" 
             onclick="selectStillBackground(${index})">
            <div class="bg-type-badge">PNG</div>
            <img src="${bg.dataUri}" alt="${bg.name}" loading="lazy">
            <div class="bg-label">${bg.name}</div>
        </div>
    `).join('');
    grid.innerHTML = html;
}

function selectAnimatedBackground(file) {
    selectedBackground = {type: 'animated', file: file, name: ANIMATED_BACKGROUNDS.find(b => b.file === file).name};
    showLoading();
    
    bgLayer.onload = () => {
        updatePreview();
        hideLoading();
        updateDownloadButtons();
    };
    bgLayer.src = `content-bg/${file}`;
    bgLayer.style.display = 'block';
    
    buildAnimatedBgGrid();
    buildStillBgGrid();
}

function selectStillBackground(index) {
    const bg = STILL_BACKGROUNDS[index];
    selectedBackground = {type: 'still', dataUri: bg.dataUri, name: bg.name};
    showLoading();
    
    bgLayer.onload = () => {
        updatePreview();
        hideLoading();
        updateDownloadButtons();
    };
    bgLayer.src = bg.dataUri;
    bgLayer.style.display = 'block';
    
    buildAnimatedBgGrid();
    buildStillBgGrid();
}

function clearBackground() {
    selectedBackground = null;
    bgLayer.style.display = 'none';
    updatePreview();
    updateDownloadButtons();
    buildAnimatedBgGrid();
    buildStillBgGrid();
}

// Preview Management
function updatePreview() {
    if (!selectedWizard) return;
    
    const scale = parseFloat(document.getElementById('dogScale').value);
    const offsetX = parseFloat(document.getElementById('dogOffsetX').value);
    const offsetY = parseFloat(document.getElementById('dogOffsetY').value);
    
    dogLayer.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    
    // Update setting values
    document.getElementById('dogScaleValue').textContent = Math.round(scale * 100) + '%';
    document.getElementById('dogOffsetXValue').textContent = offsetX + 'px';
    document.getElementById('dogOffsetYValue').textContent = offsetY + 'px';
}

function showLoading() {
    previewLoading.classList.remove('hidden');
}

function hideLoading() {
    previewLoading.classList.add('hidden');
}

// Download Management
function updateDownloadButtons() {
    const stillBtn = document.getElementById('downloadStill');
    const bgBtn = document.getElementById('downloadBg');
    
    stillBtn.disabled = !selectedWizard;
    
    if (selectedBackground && selectedBackground.type === 'animated') {
        bgBtn.style.display = 'inline-block';
        bgBtn.disabled = false;
    } else {
        bgBtn.style.display = 'none';
    }
}

function downloadStill() {
    if (!selectedWizard) {
        alert('Select a wizard first');
        return;
    }
    
    showLoading();
    
    const dog = new Image();
    dog.crossOrigin = 'anonymous';
    dog.src = `wizard-images-transparent/${selectedWizard.id}.png`;
    
    dog.onload = () => {
        ctx.clearRect(0, 0, 1000, 1000);
        
        if (selectedBackground) {
            const bg = new Image();
            bg.crossOrigin = 'anonymous';
            
            if (selectedBackground.type === 'animated') {
                bg.src = `content-bg/${selectedBackground.file}`;
            } else {
                bg.src = selectedBackground.dataUri;
            }
            
            bg.onload = () => {
                ctx.drawImage(bg, 0, 0, 1000, 1000);
                
                const scale = parseFloat(document.getElementById('dogScale').value);
                const offsetX = parseFloat(document.getElementById('dogOffsetX').value) * (1000/400);
                const offsetY = parseFloat(document.getElementById('dogOffsetY').value) * (1000/400);
                
                ctx.save();
                ctx.translate(500 + offsetX, 500 + offsetY);
                ctx.scale(scale, scale);
                ctx.drawImage(dog, -500, -500, 1000, 1000);
                ctx.restore();
                
                const link = document.createElement('a');
                link.download = `wizard-${selectedWizard.id}-${selectedBackground ? selectedBackground.name.replace(/\s+/g, '-').toLowerCase() : 'no-bg'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                hideLoading();
            };
        } else {
            // No background - solid color
            ctx.fillStyle = '#1C1C1E';
            ctx.fillRect(0, 0, 1000, 1000);
            
            const scale = parseFloat(document.getElementById('dogScale').value);
            const offsetX = parseFloat(document.getElementById('dogOffsetX').value) * (1000/400);
            const offsetY = parseFloat(document.getElementById('dogOffsetY').value) * (1000/400);
            
            ctx.save();
            ctx.translate(500 + offsetX, 500 + offsetY);
            ctx.scale(scale, scale);
            ctx.drawImage(dog, -500, -500, 1000, 1000);
            ctx.restore();
            
            const link = document.createElement('a');
            link.download = `wizard-${selectedWizard.id}-no-bg.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            hideLoading();
        }
    };
}

function downloadBackground() {
    if (!selectedBackground || selectedBackground.type !== 'animated') {
        alert('No animated background selected');
        return;
    }
    
    if (!selectedWizard) {
        // No wizard selected â€” just download raw GIF
        const link = document.createElement('a');
        link.download = `background-${selectedBackground.name.replace(/\s+/g, '-').toLowerCase()}.gif`;
        link.href = `content-bg/${selectedBackground.file}`;
        link.click();
        return;
    }
    
    showLoading();
    
    // Load the dog image first
    const dog = new Image();
    dog.crossOrigin = 'anonymous';
    dog.src = `wizard-images-transparent/${selectedWizard.id}.png`;
    
    dog.onload = () => {
        const gifUrl = `content-bg/${selectedBackground.file}`;
        
        compositeGif(gifUrl, dog).then(blob => {
            const link = document.createElement('a');
            link.download = `wizard-${selectedWizard.id}-${selectedBackground.name.replace(/\s+/g, '-').toLowerCase()}.gif`;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
            hideLoading();
        }).catch(err => {
            console.error('GIF composite failed:', err);
            alert('GIF creation failed: ' + err.message + '. Check console for details.');
            hideLoading();
        });
    };
}

async function compositeGif(gifUrl, dogImg) {
    // omggif uses CommonJS exports â€” shim it for browser
    if (!window.GifReader) {
        window.exports = window.exports || {};
        await loadScript('https://cdn.jsdelivr.net/npm/omggif@1.0.10/omggif.js');
        window.GifReader = window.exports.GifReader;
        window.GifWriter = window.exports.GifWriter;
    }
    if (!window.GIF) {
        await loadScript('https://unpkg.com/gif.js@0.2.0/dist/gif.js');
    }
    
    const resp = await fetch(gifUrl);
    const buff = await resp.arrayBuffer();
    const reader = new window.GifReader(new Uint8Array(buff));
    
    const w = reader.width;
    const h = reader.height;
    const numFrames = reader.numFrames();
    
    if (!numFrames) throw new Error('No frames found');
    
    const encoder = new GIF({
        workers: 2,
        quality: 1,
        width: w,
        height: h,
        dither: false,
        workerScript: 'gif.worker.js'
    });
    
    // Accumulator canvas (handles frame disposal properly)
    const acc = document.createElement('canvas');
    acc.width = w; acc.height = h;
    const actx = acc.getContext('2d');
    
    const scale = parseFloat(document.getElementById('dogScale').value);
    const offsetX = parseFloat(document.getElementById('dogOffsetX').value) * (w / 400);
    const offsetY = parseFloat(document.getElementById('dogOffsetY').value) * (h / 400);
    
    // Pre-render the dog layer ONCE so it's pixel-identical every frame
    const dogLayer = document.createElement('canvas');
    dogLayer.width = w; dogLayer.height = h;
    const dctx = dogLayer.getContext('2d');
    dctx.save();
    dctx.translate(w/2 + offsetX, h/2 + offsetY);
    dctx.scale(scale, scale);
    dctx.drawImage(dogImg, -w/2, -h/2, w, h);
    dctx.restore();
    
    // Get dog pixel data to use as a stable overlay
    const dogPixels = dctx.getImageData(0, 0, w, h);
    
    // Reusable composite canvas
    const comp = document.createElement('canvas');
    comp.width = w; comp.height = h;
    const cctx = comp.getContext('2d');
    
    for (let i = 0; i < numFrames; i++) {
        const info = reader.frameInfo(i);
        const pixels = new Uint8Array(w * h * 4);
        reader.decodeAndBlitFrameRGBA(i, pixels);
        
        // Put decoded frame onto accumulator
        const frameData = new ImageData(new Uint8ClampedArray(pixels.buffer), w, h);
        const tmp = document.createElement('canvas');
        tmp.width = w; tmp.height = h;
        tmp.getContext('2d').putImageData(frameData, 0, 0);
        actx.drawImage(tmp, 0, 0);
        
        // Composite: background + pre-rendered dog overlay
        cctx.clearRect(0, 0, w, h);
        cctx.drawImage(acc, 0, 0);
        cctx.drawImage(dogLayer, 0, 0);
        
        encoder.addFrame(cctx, {delay: info.delay * 10, copy: true});
    }
    
    return new Promise((resolve, reject) => {
        encoder.on('finished', blob => resolve(blob));
        encoder.on('error', reject);
        encoder.render();
    });
}

function loadScript(src) {
    return new Promise((resolve, reject) => {
        if (document.querySelector(`script[src="${src}"]`)) { resolve(); return; }
        const s = document.createElement('script');
        s.src = src;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
    });
}

// Utility Functions
function randomizeSelection() {
    const randomWizard = WIZARDS[Math.floor(Math.random() * WIZARDS.length)];
    const allBgs = [...ANIMATED_BACKGROUNDS.map(bg => ({type: 'animated', ...bg})), 
                   ...STILL_BACKGROUNDS.map((bg, i) => ({type: 'still', index: i, ...bg}))];
    const randomBg = allBgs[Math.floor(Math.random() * allBgs.length)];
    
    selectWizard(randomWizard.id);
    
    if (randomBg.type === 'animated') {
        selectAnimatedBackground(randomBg.file);
    } else {
        selectStillBackground(randomBg.index);
    }
}

function filterWizards() {
    const query = document.getElementById('wizardSearch').value;
    const order = document.getElementById('orderFilter').value;
    buildWizardGrid(query, order);
}

// Event Listeners
document.getElementById('wizardSearch').addEventListener('input', filterWizards);

// Initialize
buildWizardGrid();
buildAnimatedBgGrid();
buildStillBgGrid();
updateDownloadButtons();
</script>
</body>
</html>