<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%231C1C1E' width='180' height='180' rx='40'/><text x='90' y='125' font-size='100' text-anchor='middle' fill='%23ffd700'>86</text></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect fill='%231C1C1E' width='32' height='32' rx='6'/><text x='16' y='23' font-size='18' font-weight='bold' text-anchor='middle' fill='%23ffd700'>86</text></svg>">
    <title>The Seven Moons of Pawtheon — Order of 86 Lore</title>
    <meta name="description" content="Explore the mystical moons orbiting Pawtheon. Each moon holds ancient power and cosmic secrets tied to the 86 wizard dogs of the Order.">
    <meta name="robots" content="index, follow">
    <meta name="author" content="The Order of 86">
    <meta name="keywords" content="Order of 86, moons of Pawtheon, celestial lore, wizard dogs, NFT lore, fantasy moons, cosmic mythology">
    <link rel="canonical" href="https://theorderof86.com/moons">
    <meta property="og:title" content="Moons of Pawtheon, Order of 86">
    <meta property="og:description" content="Explore the mystical moons orbiting Pawtheon. Each moon holds ancient power and cosmic secrets tied to the 86 wizard dogs.">
    <meta property="og:image" content="https://theorderof86.com/og-image.jpg">
    <meta property="og:url" content="https://theorderof86.com/moons">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="The Order of 86">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Moons of Pawtheon, Order of 86">
    <meta name="twitter:description" content="Explore the mystical moons orbiting Pawtheon. Each moon holds ancient power and cosmic secrets tied to the 86 wizard dogs.">
    <meta name="twitter:image" content="https://theorderof86.com/og-image.jpg">
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.162.0/examples/jsm/"
        }
    }
    </script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --color-bg: #000000;
            --color-surface: #1C1C1E;
            --color-surface-2: #2C2C2E;
            --color-surface-3: #3A3A3C;
            --color-text: #F5F5F7;
            --color-text-secondary: #98989D;
            --color-text-tertiary: #636366;
            --color-border: rgba(255,255,255,0.08);
            --color-accent: #c9a86c;
            --color-accent-bright: #ffd700;
            --font-sans: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 2px 4px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.35);
            --shadow-lg: 0 4px 8px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.4);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --transition-fast: 150ms cubic-bezier(0.25,0.1,0.25,1);
            --transition-normal: 300ms cubic-bezier(0.25,0.1,0.25,1);
        }
        html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body {
            font-family: var(--font-sans);
            background: #000;
            color: var(--color-text);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
            font-size: clamp(14px, 3.5vw, 18px);
            overscroll-behavior: none;
        }

        /* ── Nav Bar ── */
        .nav-bar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 clamp(16px, 3vw, 48px); padding-top: env(safe-area-inset-top);
            height: 64px;
            background: rgba(10, 10, 12, 0.55);
            backdrop-filter: saturate(180%) blur(24px);
            -webkit-backdrop-filter: saturate(180%) blur(24px);
            border-bottom: 1px solid rgba(255, 215, 0, 0.08);
            box-shadow: 0 1px 12px rgba(255, 215, 0, 0.03);
            transition: background 0.4s ease, border-color 0.4s ease;
        }
        .nav-bar.scrolled { background: rgba(10, 10, 12, 0.92); border-bottom-color: rgba(255, 215, 0, 0.15); }
        .nav-logo {
            font-size: 20px; font-weight: 700; color: #ffd700; text-decoration: none;
            letter-spacing: 0.5px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            white-space: nowrap; flex-shrink: 0;
        }
        .nav-logo:hover { text-shadow: 0 0 24px rgba(255, 215, 0, 0.5), 0 0 48px rgba(255, 215, 0, 0.2); }
        .nav-links { display: flex; align-items: center; gap: 4px; }
        .nav-links a {
            position: relative; color: rgba(245, 245, 247, 0.55); text-decoration: none;
            font-size: 12px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase;
            padding: 8px 16px; transition: color 0.3s ease; -webkit-tap-highlight-color: transparent;
        }
        .nav-links a::after {
            content: ''; position: absolute; bottom: 0; left: 16px; right: 16px; height: 2px;
            background: #ffd700; border-radius: 1px; transform: scaleX(0); transform-origin: left;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 6px rgba(255, 215, 0, 0.4);
        }
        .nav-links a:hover { color: rgba(245, 245, 247, 0.9); }
        .nav-links a:hover::after { transform: scaleX(1); }
        .nav-links a.active { color: #ffd700; }
        .nav-links a.active::after { transform: scaleX(1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }
        .nav-hamburger {
            display: none; width: 44px; height: 44px; align-items: center; justify-content: center;
            background: none; border: none; cursor: pointer; -webkit-tap-highlight-color: transparent; padding: 0; flex-shrink: 0;
        }
        .nav-hamburger-lines { width: 22px; height: 16px; position: relative; }
        .nav-hamburger-lines span {
            display: block; position: absolute; width: 100%; height: 2px; background: #F5F5F7;
            border-radius: 1px; transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-hamburger-lines span:nth-child(1) { top: 0; }
        .nav-hamburger-lines span:nth-child(2) { top: 7px; }
        .nav-hamburger-lines span:nth-child(3) { top: 14px; }
        .nav-hamburger.is-open .nav-hamburger-lines span:nth-child(1) { top: 7px; transform: rotate(45deg); }
        .nav-hamburger.is-open .nav-hamburger-lines span:nth-child(2) { opacity: 0; transform: scaleX(0); }
        .nav-hamburger.is-open .nav-hamburger-lines span:nth-child(3) { top: 7px; transform: rotate(-45deg); }
        .nav-mobile-overlay {
            position: fixed; top: 64px; left: 0; right: 0; z-index: 99;
            background: rgba(10, 10, 12, 0.85); backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            padding: 8px 0 16px; display: flex; flex-direction: column;
            transform: translateY(-110%); opacity: 0;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
            pointer-events: none;
        }
        .nav-mobile-overlay.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .nav-mobile-overlay a {
            color: rgba(245, 245, 247, 0.6); text-decoration: none; font-size: 15px; font-weight: 600;
            letter-spacing: 0.08em; text-transform: uppercase; padding: 14px 32px;
            transition: color 0.2s ease, background 0.2s ease; -webkit-tap-highlight-color: transparent;
        }
        .nav-mobile-overlay a:hover, .nav-mobile-overlay a:active { color: #F5F5F7; background: rgba(255,255,255,0.04); }
        .nav-mobile-overlay a.active { color: #ffd700; }
        @media (max-width: 768px) { .nav-links { display: none; } .nav-hamburger { display: flex; } }
        .nav-spacer { height: 64px; padding-top: env(safe-area-inset-top); }

        /* ── Three.js Canvas ── */
        #orrery-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        /* ── Scene Overlay Title ── */
        .scene-title {
            position: fixed; top: 80px; left: 0; right: 0; text-align: center; z-index: 10;
            pointer-events: none; user-select: none;
        }
        .scene-title h1 {
            font-size: clamp(1.8rem, 4vw, 3rem); font-weight: 800; letter-spacing: 0.15em;
            background: linear-gradient(135deg, #ffd700 0%, #c9a86c 40%, #e8d5a3 70%, #ffd700 100%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; animation: shimmer 4s ease-in-out infinite;
        }
        .scene-title p {
            font-size: clamp(0.85rem, 1.6vw, 1.1rem); color: rgba(245,245,247,0.5);
            margin-top: 6px; letter-spacing: 0.05em;
        }
        @keyframes shimmer { 0%,100% { background-position: 0% center; } 50% { background-position: 200% center; } }

        /* ── Info Panel ── */
        .info-panel {
            position: fixed; top: 0; right: 0; width: 400px; height: 100vh; z-index: 50;
            background: rgba(20, 20, 24, 0.85); backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-left: 1px solid rgba(255,255,255,0.08);
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto; padding: 80px 32px 32px;
            box-shadow: -8px 0 32px rgba(0,0,0,0.5);
        }
        .info-panel.open { transform: translateX(0); }
        .info-panel-close {
            position: absolute; top: 20px; right: 20px; width: 36px; height: 36px;
            border-radius: 50%; border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06); color: #fff; font-size: 18px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; z-index: 2;
        }
        .info-panel-close:hover { background: rgba(255,255,255,0.15); }
        .info-panel .moon-header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .info-panel .moon-icon { width: 48px; height: 48px; border-radius: 50%; flex-shrink: 0; }
        .info-panel .moon-title { font-size: 24px; font-weight: 800; }
        .info-panel .moon-order { font-size: 13px; color: var(--color-text-secondary); letter-spacing: 0.05em; text-transform: uppercase; }
        .info-panel .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .info-panel .info-label { color: var(--color-text-secondary); font-size: 13px; }
        .info-panel .info-value { font-weight: 600; font-size: 14px; }
        .phase-bar-wrap { margin: 16px 0; }
        .phase-bar-bg { height: 8px; border-radius: 4px; background: rgba(255,255,255,0.08); overflow: hidden; }
        .phase-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .info-panel .lore-text { margin-top: 20px; color: var(--color-text-secondary); font-size: 14px; line-height: 1.7; font-style: italic; }

        @media (max-width: 768px) {
            .info-panel {
                top: auto; bottom: 0; left: 0; right: 0; width: 100%; height: 70vh;
                border-left: none; border-top: 1px solid rgba(255,255,255,0.08);
                border-radius: 20px 20px 0 0; transform: translateY(100%);
                padding: 24px 20px 40px;
            }
            .info-panel.open { transform: translateY(0); }
            .info-panel-close { top: 12px; right: 12px; }
        }

        /* Moon cards removed — details via click panel */

        /* ── Scroll indicator ── */
        .scroll-hint {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 10;
            color: rgba(255,255,255,0.3); font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase;
            pointer-events: none; animation: bob 2s ease-in-out infinite;
        }
        @keyframes bob { 0%,100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(6px); } }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
        }
    </style>
</head>
<body>

<nav class="nav-bar" id="mainNav">
    <a href="index.html" class="nav-logo">The Order of 86</a>
    <div class="nav-links">
        <a href="index.html">Wizards</a>
        <a href="moons.html" class="active">Moons</a>
        <a href="map.html">Map</a>
        <a href="lore.html">Lore</a>
        <a href="content.html">Content</a>
    </div>
    <button class="nav-hamburger" id="navHamburger" aria-label="Menu">
        <div class="nav-hamburger-lines"><span></span><span></span><span></span></div>
    </button>
</nav>
<div class="nav-mobile-overlay" id="navMobileMenu">
    <a href="index.html">Wizards</a>
    <a href="moons.html" class="active">Moons</a>
    <a href="map.html">Map</a>
    <a href="lore.html">Lore</a>
    <a href="content.html">Content</a>
</div>

<canvas id="orrery-canvas"></canvas>

<div class="scene-title">
    <h1>THE CANINOSPHERE</h1>
    <p>The Seven Moons of Pawtheon</p>
</div>

<!-- Info Panel -->
<div class="info-panel" id="infoPanel">
    <button class="info-panel-close" id="infoPanelClose">✕</button>
    <div id="infoPanelContent"></div>
</div>

<div class="scroll-hint" id="scrollHint">Click a moon to explore</div>

<!-- Moon details shown via click panel -->

<script>
// Nav logic
const hamburger = document.getElementById('navHamburger');
const mobileMenu = document.getElementById('navMobileMenu');
hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('is-open');
    mobileMenu.classList.toggle('open');
});
window.addEventListener('scroll', () => {
    document.getElementById('mainNav').classList.toggle('scrolled', window.scrollY > 10);
    const hint = document.getElementById('scrollHint');
    if (hint && window.scrollY > 50) hint.style.opacity = '0';
});
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

const MOONS = [
    { name: 'Emberhowl', order: 'Flame', color: '#FF6B00', cycle: 18, wizards: 18, radius: 4.5, inclination: 0.1, size: 0.35,
      lore: "Tied to the Flame Order. Its 18-day cycle matches its 18 Wizards. When full, Flame magic surges through the Forge Spire and volcanic energy peaks across the Ember Wastes. When new, Flame Wizards rely on raw skill and pack bonds." },
    { name: 'Solaris', order: 'Radiant', color: '#F1C40F', cycle: 12, wizards: 12, radius: 6.0, inclination: -0.15, size: 0.32,
      lore: "Tied to the Radiant Order. Its 12-day cycle, the shortest of the Order moons, creates rapid power fluctuations. The Crystal Spires of Sunward Heights blaze brightest under a full Solaris. Radiant Wizards experience the most dramatic power swings." },
    { name: 'Deepwell', order: 'Deep', color: '#3498DB', cycle: 13, wizards: 13, radius: 7.5, inclination: 0.2, size: 0.33,
      lore: "Tied to the Deep Order. Its 13-day cycle governs prophecy and ocean magic. When full, Tidewatch Tower's waters rise and Deep Wizards see furthest into the future. When new, the Abyssal Reaches fall eerily silent." },
    { name: 'Evergreen', order: 'Wild', color: '#2ECC71', cycle: 18, wizards: 18, radius: 9.0, inclination: -0.08, size: 0.34,
      lore: "Tied to the Wild Order. Its 18-day cycle mirrors Emberhowl's, creating a fire-and-growth resonance. When full, the Heartwood tree grows visibly. When new, the forest conserves energy, drawing inward." },
    { name: 'Umbra', order: 'Arcane', color: '#9B6EFF', cycle: 14, wizards: 14, radius: 10.5, inclination: 0.25, size: 0.3,
      lore: "Tied to the Arcane Order. Its 14-day cycle governs theoretical magic and dimensional research. When full, the Violet Citadel's archives glow with autonomous magical energy. When new, Arcane Wizards must rely on studied technique." },
    { name: 'Roseglow', order: 'Heart', color: '#FF69B4', cycle: 11, wizards: 11, radius: 12.0, inclination: -0.18, size: 0.31,
      lore: "Tied to the Heart Order. Its 11-day cycle, the fastest Order moon, creates the most frequent power surges. The Heartstring Tower resonates constantly. Heart Wizards ride emotional waves that never fully calm." },
    { name: 'Palehowl', order: 'Starter', color: '#dddddd', cycle: 30, wizards: 0, radius: 14.0, inclination: 0.12, size: 0.2,
      lore: "The smallest, dimmest moon. The seventh tone of the First Howl, carrying not power but possibility. It provides baseline magic to all non-wizard dogs. Weak individually, but it touches EVERYONE. The Wanderer resonates with Palehowl." },
];

const isMobile = window.innerWidth < 768;
const canvas = document.getElementById('orrery-canvas');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: !isMobile, alpha: false });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = false;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
scene.fog = new THREE.FogExp2(0x000000, 0.012);

const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 200);
camera.position.set(12, 8, 18);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.minDistance = 6;
controls.maxDistance = 50;
controls.maxPolarAngle = Math.PI * 0.85;
controls.target.set(0, 0, 0);

// Ambient light
scene.add(new THREE.AmbientLight(0x222233, 0.5));
const sunLight = new THREE.DirectionalLight(0xffeedd, 1.2);
sunLight.position.set(20, 15, 10);
scene.add(sunLight);

// ── Stars ──
const starCount = isMobile ? 1000 : 2000;
const starGeo = new THREE.BufferGeometry();
const starPos = new Float32Array(starCount * 3);
for (let i = 0; i < starCount * 3; i++) starPos[i] = (Math.random() - 0.5) * 160;
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, sizeAttenuation: true })));

// ── Pawtheon (central planet with 7 realms) ──
const planetSegs = isMobile ? 32 : 48;
const planetGeo = new THREE.BoxGeometry(3.5, 3.5, 3.5, planetSegs, planetSegs, planetSegs);
// Round edges slightly for a "rounded cube" feel
{
    const pos = planetGeo.attributes.position;
    const v = new THREE.Vector3();
    for (let i = 0; i < pos.count; i++) {
        v.set(pos.getX(i), pos.getY(i), pos.getZ(i));
        const len = v.length();
        v.normalize().multiplyScalar(len * 0.85 + 1.75 * 0.15); // blend toward sphere slightly
        pos.setXYZ(i, v.x, v.y, v.z);
    }
    pos.needsUpdate = true;
}

// 7 realm regions mapped to spherical coordinates
// Each realm has a center (theta, phi) on the sphere and a color palette
const realmRegions = [
    { name:'Frosthollow',      theta:-0.6, phi: 2.4,  r:0.85,g:0.92,b:1.0,  r2:0.6,g2:0.75,b2:0.95 },  // icy white-blue (northwest)
    { name:'Abyssal Reaches',  theta: 0.0, phi: 2.8,  r:0.15,g:0.25,b:0.45, r2:0.1,g2:0.2,b2:0.4 },    // dark blue (north coast)
    { name:'Sunward Heights',  theta: 0.6, phi: 2.4,  r:1.0,g:0.92,b:0.7,   r2:0.95,g2:0.85,b2:0.6 },  // golden (northeast)
    { name:'Ember Wastes',     theta: 0.8, phi: 1.2,  r:0.5,g:0.18,b:0.05,  r2:0.3,g2:0.1,b2:0.02 },   // volcanic dark red-brown (east)
    { name:'Deepwood',         theta: 0.4, phi: 0.6,  r:0.1,g:0.35,b:0.08,  r2:0.15,g2:0.45,b2:0.12 },  // deep green (southeast)
    { name:'Violet Highlands', theta:-0.5, phi: 0.8,  r:0.4,g:0.22,b:0.5,   r2:0.3,g2:0.18,b2:0.4 },   // purple (southwest)
    { name:'Shadowmire',       theta: 0.0, phi: 0.4,  r:0.12,g:0.15,b:0.08, r2:0.08,g2:0.1,b2:0.05 },   // dark swamp (south)
    { name:'Starter Lands',    theta: 0.0, phi: 1.57, r:0.35,g:0.5,b:0.3,   r2:0.4,g2:0.55,b2:0.35 },   // gentle green (center)
];

const colors = new Float32Array(planetGeo.attributes.position.count * 3);
const posArr = planetGeo.attributes.position.array;
const _v = new THREE.Vector3();

for (let i = 0; i < planetGeo.attributes.position.count; i++) {
    _v.set(posArr[i*3], posArr[i*3+1], posArr[i*3+2]).normalize();
    const theta = Math.atan2(_v.x, _v.z); // -PI to PI
    const phi = Math.acos(_v.y);           // 0 (north) to PI (south)

    // Find closest realm with smooth blending
    let totalW = 0;
    let cr = 0, cg = 0, cb = 0;
    for (const realm of realmRegions) {
        // Angular distance on sphere
        const dTheta = theta - realm.theta;
        const dPhi = phi - realm.phi;
        const dist = Math.sqrt(dTheta * dTheta + dPhi * dPhi);
        const w = Math.pow(Math.max(0, 1 - dist / 1.8), 3);
        if (w > 0) {
            const t = Math.random() * 0.3;
            const mr = realm.r * (1-t) + realm.r2 * t;
            const mg = realm.g * (1-t) + realm.g2 * t;
            const mb = realm.b * (1-t) + realm.b2 * t;
            cr += mr * w; cg += mg * w; cb += mb * w;
            totalW += w;
        }
    }

    if (totalW > 0) {
        colors[i*3] = cr / totalW;
        colors[i*3+1] = cg / totalW;
        colors[i*3+2] = cb / totalW;
    } else {
        // Ocean fill for gaps
        const t = Math.random() * 0.2;
        colors[i*3] = 0.05 + t * 0.1;
        colors[i*3+1] = 0.15 + t * 0.15;
        colors[i*3+2] = 0.35 + t * 0.3;
    }

    // Add ocean between realms where influence is weak
    if (totalW < 0.15) {
        const oceanT = Math.max(0, 1 - totalW / 0.15);
        colors[i*3] = colors[i*3] * (1-oceanT) + 0.06 * oceanT;
        colors[i*3+1] = colors[i*3+1] * (1-oceanT) + 0.18 * oceanT;
        colors[i*3+2] = colors[i*3+2] * (1-oceanT) + 0.45 * oceanT;
    }
}

// Topography: displace vertices outward based on realm + noise
const topoNormals = [];
for (let i = 0; i < planetGeo.attributes.position.count; i++) {
    const px = posArr[i*3], py = posArr[i*3+1], pz = posArr[i*3+2];
    const n = _v.set(px, py, pz).normalize();
    topoNormals.push(n.x, n.y, n.z);

    // Noise-based height: combine multiple frequencies
    const n1 = Math.sin(px * 4.3 + pz * 3.1) * Math.cos(py * 5.7) * 0.5;
    const n2 = Math.sin(px * 8.7 + py * 6.2) * Math.cos(pz * 9.1) * 0.25;
    const n3 = Math.sin(px * 15.3 + pz * 12.8) * 0.12;
    let height = (n1 + n2 + n3);

    // Realm-specific height multipliers
    const theta = Math.atan2(n.x, n.z);
    const phi = Math.acos(n.y);

    // Frosthollow: tall peaks
    const fhDist = Math.sqrt((theta+0.6)**2 + (phi-2.4)**2);
    if (fhDist < 1.2) height += Math.abs(height) * 1.5 * Math.max(0, 1-fhDist/1.2);

    // Ember Wastes: volcanic ridges
    const ewDist = Math.sqrt((theta-0.8)**2 + (phi-1.2)**2);
    if (ewDist < 1.0) height += Math.abs(Math.sin(px*12)*Math.cos(pz*10)) * 0.3 * Math.max(0, 1-ewDist/1.0);

    // Violet Highlands: terraced steps
    const vhDist = Math.sqrt((theta+0.5)**2 + (phi-0.8)**2);
    if (vhDist < 1.0) height = Math.round(height * 4) / 4 * 1.3;

    // Shadowmire/Deepwood: low and flat
    const smDist = Math.sqrt(theta**2 + (phi-0.4)**2);
    if (smDist < 0.8) height *= 0.3;

    // Ocean areas: flatten
    if (colors[i*3+2] > 0.35 && colors[i*3] < 0.1) height *= 0.15;

    const displacement = height * 0.18;
    posArr[i*3] += n.x * displacement;
    posArr[i*3+1] += n.y * displacement;
    posArr[i*3+2] += n.z * displacement;
}
planetGeo.attributes.position.needsUpdate = true;
planetGeo.computeVertexNormals();

planetGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
const planet = new THREE.Mesh(planetGeo, new THREE.MeshStandardMaterial({
    vertexColors: true, roughness: 0.7, metalness: 0.1, flatShading: true
}));
scene.add(planet);

// ── Orbit Rings (dashed) ──
MOONS.forEach(m => {
    const pts = [];
    for (let i = 0; i <= 128; i++) {
        const a = (i / 128) * Math.PI * 2;
        pts.push(new THREE.Vector3(Math.cos(a) * m.radius, Math.sin(m.inclination) * Math.sin(a) * m.radius * 0.15, Math.sin(a) * m.radius));
    }
    const geo = new THREE.BufferGeometry().setFromPoints(pts);
    const mat = new THREE.LineDashedMaterial({ color: new THREE.Color(m.color), opacity: 0.15, transparent: true, dashSize: 0.5, gapSize: 0.3 });
    const line = new THREE.Line(geo, mat);
    line.computeLineDistances();
    scene.add(line);
});

// ── Moon objects ──
const moonSegs = isMobile ? 16 : 24;
const baseSpeed = 0.3;
const moonGroups = [];
const moonMeshes = []; // for raycasting
const raycaster = new THREE.Raycaster();
const pointer = new THREE.Vector2();

MOONS.forEach((m, idx) => {
    const group = new THREE.Group();

    // Moon sphere
    const col = new THREE.Color(m.color);
    const moonGeo = new THREE.SphereGeometry(m.size, moonSegs, moonSegs);
    const moonMat = new THREE.MeshStandardMaterial({ color: col, emissive: col, emissiveIntensity: 0.6, roughness: 0.5, metalness: 0.2 });
    const moonMesh = new THREE.Mesh(moonGeo, moonMat);
    moonMesh.userData = { moonIndex: idx };
    group.add(moonMesh);
    moonMeshes.push(moonMesh);

    // Shadow hemisphere for phase
    const shadowGeo = new THREE.SphereGeometry(m.size + 0.005, moonSegs, moonSegs, 0, Math.PI);
    const shadowMat = new THREE.MeshBasicMaterial({ color: 0x000000, opacity: 0.85, transparent: true, side: THREE.DoubleSide });
    const shadowMesh = new THREE.Mesh(shadowGeo, shadowMat);
    moonMesh.add(shadowMesh);
    m._shadow = shadowMesh;

    // Glow sprite
    const spriteMat = new THREE.SpriteMaterial({
        map: createGlowTexture(m.color),
        transparent: true, opacity: 0.5, depthWrite: false, blending: THREE.AdditiveBlending
    });
    const sprite = new THREE.Sprite(spriteMat);
    sprite.scale.set(m.size * 4, m.size * 4, 1);
    moonMesh.add(sprite);
    m._glowSprite = sprite;

    // Label sprite
    const labelSprite = createTextSprite(m.name, m.color);
    labelSprite.position.set(0, m.size + 0.4, 0);
    labelSprite.scale.set(1.6, 0.4, 1);
    moonMesh.add(labelSprite);

    group.userData = { moon: m, speed: baseSpeed / m.cycle, angle: (idx / MOONS.length) * Math.PI * 2 };
    scene.add(group);
    moonGroups.push(group);
    m._mesh = moonMesh;
    m._group = group;
});

function createGlowTexture(hexColor) {
    const size = 128;
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const ctx = c.getContext('2d');
    const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size/2);
    grad.addColorStop(0, hexColor + 'aa');
    grad.addColorStop(0.4, hexColor + '44');
    grad.addColorStop(1, hexColor + '00');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, size, size);
    const tex = new THREE.CanvasTexture(c);
    return tex;
}

function createTextSprite(text, color) {
    const c = document.createElement('canvas');
    c.width = 256; c.height = 64;
    const ctx = c.getContext('2d');
    ctx.font = 'bold 28px -apple-system, sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillStyle = color;
    ctx.fillText(text, 128, 32);
    const tex = new THREE.CanvasTexture(c);
    const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthWrite: false });
    return new THREE.Sprite(mat);
}

// ── Phase helpers ──
const PHASE_NAMES = ['New', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous', 'Full', 'Waning Gibbous', 'Third Quarter', 'Waning Crescent'];
function getPhase(time, cycle) {
    const p = ((time * 0.05) % cycle) / cycle; // 0-1
    return p;
}
function getPhaseName(p) {
    const idx = Math.floor(p * 8) % 8;
    return PHASE_NAMES[idx];
}
function getMagicPower(p) {
    // fullness peaks at 0.5
    const fullness = 1 - Math.abs(p - 0.5) * 2; // 0 at new, 1 at full
    if (fullness > 0.8) return 'Surging';
    if (fullness > 0.5) return 'Strong';
    if (fullness > 0.2) return 'Dim';
    return 'Dormant';
}

// ── Info panel logic ──
const infoPanel = document.getElementById('infoPanel');
const infoPanelContent = document.getElementById('infoPanelContent');
document.getElementById('infoPanelClose').addEventListener('click', () => infoPanel.classList.remove('open'));

let hoveredMoon = null;
let selectedMoon = null;

function showMoonInfo(m, time) {
    const p = getPhase(time, m.cycle);
    const phaseName = getPhaseName(p);
    const fullness = 1 - Math.abs(p - 0.5) * 2;
    const power = getMagicPower(p);
    const pct = Math.round(fullness * 100);
    infoPanelContent.innerHTML = `
        <div class="moon-header">
            <div class="moon-icon" style="background:${m.color};box-shadow:0 0 20px ${m.color}88;"></div>
            <div>
                <div class="moon-title" style="color:${m.color}">${m.name}</div>
                <div class="moon-order">${m.order} Order</div>
            </div>
        </div>
        <div class="info-row"><span class="info-label">Phase</span><span class="info-value">${phaseName}</span></div>
        <div class="phase-bar-wrap">
            <div class="phase-bar-bg"><div class="phase-bar-fill" style="width:${pct}%;background:${m.color};box-shadow:0 0 8px ${m.color}88;"></div></div>
            <div style="text-align:right;font-size:11px;color:var(--color-text-secondary);margin-top:4px;">${pct}% illuminated</div>
        </div>
        <div class="info-row"><span class="info-label">Magic Power</span><span class="info-value" style="color:${m.color}">${power}</span></div>
        <div class="info-row"><span class="info-label">Cycle Length</span><span class="info-value">${m.cycle} days</span></div>
        <div class="info-row"><span class="info-label">Wizards</span><span class="info-value">${m.wizards}</span></div>
        <div class="lore-text">"${m.lore}"</div>
    `;
    infoPanel.classList.add('open');
}

// ── Interaction ──
function onPointerMove(e) {
    pointer.x = (e.clientX / window.innerWidth) * 2 - 1;
    pointer.y = -(e.clientY / window.innerHeight) * 2 + 1;
}
let _downX = 0, _downY = 0;
function onPointerDown(e) {
    _downX = e.clientX; _downY = e.clientY;
}
function onPointerUp(e) {
    const dx = e.clientX - _downX, dy = e.clientY - _downY;
    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) return; // was a drag, not a click
    pointer.x = (e.clientX / window.innerWidth) * 2 - 1;
    pointer.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(pointer, camera);
    const hits = raycaster.intersectObjects(moonMeshes);
    if (hits.length > 0) {
        const idx = hits[0].object.userData.moonIndex;
        selectedMoon = MOONS[idx];
        showMoonInfo(selectedMoon, performance.now() * 0.001);
    }
}
window.addEventListener('pointermove', onPointerMove);
window.addEventListener('pointerdown', onPointerDown);
window.addEventListener('pointerup', onPointerUp);

// SEO cards removed — moon details shown via click panel

// ── Animation ──
function animate() {
    requestAnimationFrame(animate);
    const t = performance.now() * 0.001;

    // Rotate planet
    planet.rotation.y = t * 0.15;
    planet.rotation.x = Math.sin(t * 0.03) * 0.1; // subtle axial tilt wobble

    // Update moons
    raycaster.setFromCamera(pointer, camera);
    const hits = raycaster.intersectObjects(moonMeshes);
    const hitIdx = hits.length > 0 ? hits[0].object.userData.moonIndex : -1;

    moonGroups.forEach((g, i) => {
        const m = MOONS[i];
        const d = g.userData;
        d.angle += d.speed * 0.016;
        const a = d.angle;

        // Position on orbit
        const x = Math.cos(a) * m.radius;
        const z = Math.sin(a) * m.radius;
        const y = Math.sin(m.inclination) * Math.sin(a) * m.radius * 0.15;
        m._mesh.position.set(x, y, z);

        // Phase shadow rotation
        const phase = getPhase(t, m.cycle);
        const shadowAngle = phase * Math.PI * 2;
        m._shadow.rotation.y = shadowAngle;

        // Hover effect
        const isHovered = (hitIdx === i);
        const targetScale = isHovered ? 1.25 : 1.0;
        const cs = m._mesh.scale.x;
        const ns = cs + (targetScale - cs) * 0.1;
        m._mesh.scale.setScalar(ns);
        m._glowSprite.material.opacity = isHovered ? 0.8 : 0.4;
        canvas.style.cursor = isHovered ? 'pointer' : 'default';
    });

    controls.update();
    renderer.render(scene, camera);
}
animate();

// ── Resize ──
window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

<script src="sparkle.js" defer></script>
<script src="orb-cursor.js" defer></script>
</body>
</html>
